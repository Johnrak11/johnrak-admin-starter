services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: johnrak-admin-backend
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "https://admin-service.johnrak.online"
      FRONTEND_ORIGIN: "https://admin.johnrak.online"
      # Force connection to host's mapped MariaDB (v-store-db:3307)
      DB_HOST: host.docker.internal
      DB_PORT: 3307
    env_file: 
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - web_gateway
      - internal

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: johnrak-admin-frontend
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - FRONTEND_DOMAIN=admin.johnrak.online
      - BACKEND_DOMAIN=admin-service.johnrak.online
      - ACME_EMAIL=admin@johnrak.online
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - web_gateway
      - internal
    depends_on:
      - backend

networks:
  web_gateway:
    external: true
  internal:

volumes:
  caddy_data:
  caddy_config:
